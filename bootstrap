#!/usr/bin/env zsh

function makelink {
    local prev
    local dst

    prev="$(pwd)"
    [[ -n "$2" ]] && dst="$2" || dst="$HOME"
    cd "$dst" || exit 1

    echo -e "Linking $1 to $dst\n"
    if [[ -d "$1" ]]; then
        /bin/ln -sF "$1" && cd "$prev" || exit 1
    elif [[ -f "$1" ]]; then
        /bin/ln -sf "$1" && cd "$prev" || exit 1
    else
        echo -e "Could not find '$1', not linking!\n"
    fi
    cd "$prev"
}

function setup_vim {
    makelink ~/dotfiles/.vim
    makelink ~/dotfiles/.vimrc
    makelink ~/dotfiles/.xvimrc

    makelink ~/Library/Mobile\ Documents/com~apple~CloudDocs/Vim/pack ~/.vim
    makelink ~/Library/Mobile\ Documents/com~apple~CloudDocs/Vim/spell ~/.vim

    mkdir -p ~/.vim/backup/undo
}

function setup_shell_tools {
    cd "$HOME" || exit 1

    makelink ~/dotfiles/.zsh
    makelink ~/dotfiles/.zshrc
    makelink ~/dotfiles/.zshenv

    makelink ~/dotfiles/.ipython
    makelink ~/dotfiles/.bin
}

function setup_osx_defaults {
    echo -e "Setting up OS X defaults...\n"
    [ ! -d "$HOME/.cache" ] && mkdir "$HOME/.cache"
    defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
    defaults write NSGlobalDomain KeyRepeat -int 0
}

function setup_git {
    makelink ~/dotfiles/.tigrc
    makelink ~/dotfiles/.git_template
}

echo -e "Bootstrapping...\n"
setup_vim
setup_shell_tools
setup_git
setup_osx_defaults
echo -e "Done!\n"
