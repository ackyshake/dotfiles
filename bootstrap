#!/usr/bin/env bash

function header() {
    echo -e "$(tput bold)$1$(tput sgr0)"
}

function link_file {
    header "Linking $1..."
    local prev
    prev=$(pwd)
    cd "$HOME" && /bin/ln -sfv "$1" && cd "$prev" || exit 1
}

function link_folder {
    header "Linking $1..."
    local prev
    prev=$(pwd)
    cd "$HOME" && /bin/ln -sFv "$1" && cd "$prev" || exit 1
}

function setup_vim {
    link_folder ~/dotfiles/.vim
    link_file ~/dotfiles/.vimrc
    link_file ~/dotfiles/.xvimrc

    header "Creating vim backup folders..."
    mkdir -p ~/.vim/backup/undo

    header "Copying over vim packages from iCloud..."
    rsync -avz --info=progress2 ~/Library/Mobile\ Documents/com~apple~CloudDocs/Vim/pack ~/.vim/
}

function setup_shell_tools {
    cd "$HOME" || exit 1

    link_folder ~/dotfiles/.zsh
    link_file ~/dotfiles/.zshrc
    link_file ~/dotfiles/.zshenv

    link_folder ~/Library/Mobile\ Documents/com~apple~CloudDocs/.gnupg
    link_folder ~/dotfiles/.ipython
    link_folder ~/dotfiles/.bin
}

function setup_misc_tools {
    cd "$HOME/.config" || mkdir ~/.config && cd "$HOME/.config" || exit 1
    link_folder ~/dotfiles/mpv
}

function setup_osx_defaults {
    header "\nSetting up OS X defaults..."
    [ ! -d "$HOME/.cache" ] && mkdir "$HOME/.cache"
    defaults write NSGlobalDomain ApplePressAndHoldEnabled -bool false
    defaults write NSGlobalDomain KeyRepeat -int 0
}

function setup_git {
    link_file ~/dotfiles/.tigrc
    link_folder ~/dotfiles/.git_template
}

header "\nBootstrapping..."
setup_vim
setup_shell_tools
setup_misc_tools
setup_git
setup_osx_defaults
header "\nDone!"
